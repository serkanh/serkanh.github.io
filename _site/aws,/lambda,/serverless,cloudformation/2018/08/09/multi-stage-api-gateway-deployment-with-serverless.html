<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Multi stage api gateway deployment with serverless framework.</title>
	
	<meta name="author" content="serkan haytac">
    
	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/serkanh">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/shaytac">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:shaytac at gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="/assets/imgs/profileimg.jpg" class="img-circle" />
				serkan haytac
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/imgs/profileimg.jpg" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">serkan haytac</a>
    </h3>
</header>


<div id="bio" class="text-center">
	<a href="https://www.certmetrics.com/amazon/public/badge.aspx?i=1&t=c&d=2016-07-01&ci=AWS00186868">AWS Certified Solutions Architect - Associate</a><br /><a href="https://www.certmetrics.com/amazon/public/badge.aspx?i=2&t=c&d=2016-07-23&ci=AWS00186868">AWS Certified Developer - Associate</a><br /><a href="https://www.certmetrics.com/amazon/public/badge.aspx?i=3&t=c&d=2018-01-12&ci=AWS00186868">AWS Certified SysOps Administrator - Associate</a><br /> <a href="https://gist.github.com/serkanh">Gists</><br /><a href="/resources">Resources</a><br /><a href="/one-liners">One liners</a><br/>
<br />
<a href="https://github.com/serkanh/react-cognito-starter">React/Serverless cognito starter</a><br/>
<a href="https://github.com/serkanh/github-explorer">React github explorer</a><br/>
<a href="https://github.com/serkanh/aws-eks">Terraform AWS EKS POC</a><br/>
<a href="https://github.com/serkanh/ecs-audit-js">JS/AWS ECS audit util</a><br/>
<a href="https://github.com/serkanh/django-multitenant-starter">Django multi-tenant starter</a><br/>
<a href="https://github.com/serkanh/nginx-docker">Dockerized nginx for config tests</a><br/>
<a href="https://github.com/serkanh/devops-panel">Serverless/React ui to manage ecs clusters</a><br/>

</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/serkanh">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/shaytac">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:shaytac at gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/serkanhaytac">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Multi stage api gateway deployment with serverless framework. </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   August 
	   9th,
	   
	   2018
	 </span>
	  <div class="article_body">
	  <p>Both serverless framework and api gateway has the concept of stages.</p>

<p>We will build a serverless application with api gateway and deploy it to multiple stages. What this means is that <code class="language-plaintext highlighter-rouge">dev</code> lambda functions will be associated with the api gateways <code class="language-plaintext highlighter-rouge">/dev/</code> stage and prod with <code class="language-plaintext highlighter-rouge">prod</code> stage.</p>

<p>First we start by setting up multiple stages for our lambda functions. To keep it simple we will simply set different environment variables per lambda function stage. Function basically will read from the env var and return its value as a string. We will deploy to different stages with serverless’ <code class="language-plaintext highlighter-rouge">--stage</code> flag.</p>

<p><a href="https://github.com/serkanh/serverless-api-gateway-multi-stage-demo">Repo url</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
service: serverless-api-gateway-multi-stage-demo

## This is where we setup env variables that will be set for different stages of lambda functions.
custom:
  dev_APP_STAGE: 'DEV STAGE'
  prod_APP_STAGE: 'PROD STAGE'
provider:
  name: aws
  runtime: nodejs8.10
  environment:
    APP_STAGE: ${self:custom.${opt:stage, self:provider.stage}_APP_STAGE}
functions:
  hello:
    handler: handler.hello

</code></pre></div></div>

<p>and deploy to both <code class="language-plaintext highlighter-rouge">dev</code> and <code class="language-plaintext highlighter-rouge">prod</code> stages</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sls deploy --stage=dev
sls deploy --stage=prod
</code></pre></div></div>

<p>if you are using aws profiles you can deploy by specifiying the aws profile you’d like to use <code class="language-plaintext highlighter-rouge">sls --aws-profile=&lt;aws-personal-profile&gt; deploy --stage=dev</code></p>

<p>When you invoke the function on both envs, it should simply return the env name a string.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  serverless-api-gateway-multi-stage-demo git:(master) ✗ sls invoke -f hello --stage=dev
{
    "statusCode": 200,
    "body": "{\"message\":\"Current lambda function env DEV STAGE\",\"input\":{}}"
}

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  serverless-api-gateway-multi-stage-demo git:(master) ✗ sls invoke -f hello --stage=prod
{
    "statusCode": 200,
    "body": "{\"message\":\"Current lambda function env PROD STAGE\",\"input\":{}}"
}

</code></pre></div></div>

<p>Now we want to create a openapi(swagger) file to define paths for our api. Also we will add api gateway stages, deployment and associated stage variables for api gateway.</p>

<p>One gotcha of this setup is that we need to give permissions to api gateway to execute each individual function based on env. This is because we are using lambda functions stage name as a api gateway stage variable.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>swagger: "2.0"
schemes:
- "https"
paths:
  /:
    get:
      produces:
      - "application/json"
      responses:
        200:
          description: "200 response"
          schema:
            $ref: "#/definitions/Empty"
      x-amazon-apigateway-integration:
        uri: "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:174076265606:function:serverless-multistage-${stageVariables.Stage}-hello/invocations"
        responses:
          default:
            statusCode: "200"
        passthroughBehavior: "when_no_match"
        httpMethod: "POST"
        contentHandling: "CONVERT_TO_TEXT"
        type: "aws"
definitions:
  Empty:
    type: "object"
    title: "Empty Schema"
</code></pre></div></div>

<p>We will include the swagger file in our serverless.yml. One gotcha of using api gateway stage variables in serverless is that both serverless and api gateway and serverless framework is using the same syntax to refer to variables. In order to get around this we will use custom variable syntax so serverless does not interpret this as a serverless variable.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//serverless.yml
provider:
  name: aws
  runtime: nodejs8.10
  environment:
    APP_STAGE: ${self:custom.${opt:stage, self:provider.stage}_APP_STAGE}
  variableSyntax: "\\${((?!stageVariables)[ ~:a-zA-Z0-9._'\",\\-\\/\\(\\)]+?)}"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//swagger.yml
 x-amazon-apigateway-integration:
        uri: "arn:aws:apigateway:us-east-1:lambda:path/2015-03-31/functions/arn:aws:lambda:us-east-1:174076265606:function:serverless-multistage-${stageVariables.Stage}-hello/invocations"
</code></pre></div></div>
<p>Give api-gateway execute perm on dev hello function</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
aws lambda add-permission    --function-name "arn:aws:lambda:us-east-1:174076265606:function:serverless-multistage-dev-hello"    --source-arn "arn:aws:execute-api:us-east-1:174076265606:rci6d8tuc7/*/GET/"   --principal apigateway.amazonaws.com    --statement-id 8513374b-509d-4cfc-920c-c69e72264c7a    --action lambda:InvokeFunction

</code></pre></div></div>

<p>Give api-gateway execute perm on prod  hello function</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws lambda add-permission    --function-name "arn:aws:lambda:us-east-1:174076265606:function:serverless-multistage-prod-hello"    --source-arn "arn:aws:execute-api:us-east-1:174076265606:rci6d8tuc7/*/GET/"   --principal apigateway.amazonaws.com    --statement-id 8513374b-509d-4cfc-920c-c69e72264c7a    --action lambda:InvokeFunction

</code></pre></div></div>

<p>Final <code class="language-plaintext highlighter-rouge">serverless.yml</code> should look like below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

service: serverless-multistage

##### This is where we setup env variables that will be set for different stages of lambda functions.
custom:
  dev_APP_STAGE: 'DEV STAGE'
  prod_APP_STAGE: 'PROD STAGE'


provider:
  name: aws
  runtime: nodejs8.10
  environment:
    APP_STAGE: ${self:custom.${opt:stage, self:provider.stage}_APP_STAGE}
  variableSyntax: "\\${((?!stageVariables)[ ~:a-zA-Z0-9._'\",\\-\\/\\(\\)]+?)}"
resources:
  Resources:
    ApiGatewayRestApi:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Name: ${self:service}
        Body: ${file(swagger.yml)}
    ApiGatewayDeploymentDev:
      Type: AWS::ApiGateway::Deployment
      Properties:
        RestApiId:
          Ref: ApiGatewayRestApi
        Description: 'Dev deployment'

    
    ApiGatewayDeploymentProd:
      Type: AWS::ApiGateway::Deployment
      Properties:
        RestApiId:
          Ref: ApiGatewayRestApi
        Description: 'Prod Deployment'

    ApiGatewayStageDev:
        Type: 'AWS::ApiGateway::Stage'
        Properties:
          StageName: dev
          Description: Dev Stage
          RestApiId: 
            Ref: ApiGatewayRestApi
          DeploymentId: 
            Ref: ApiGatewayDeploymentDev
          Variables:
            "Stage": "dev"
    ApiGatewayStageProd:
        Type: 'AWS::ApiGateway::Stage'
        Properties:
          StageName: prod
          Description: Prod Stage
          RestApiId: 
            Ref: ApiGatewayRestApi
          DeploymentId: 
            Ref: ApiGatewayDeploymentProd
          Variables:
            "Stage": "prod"

functions:
  hello:
    handler: handler.hello


</code></pre></div></div>

<p>To test the <code class="language-plaintext highlighter-rouge">dev</code> and <code class="language-plaintext highlighter-rouge">prod</code> functionality in api gateway simply go into api gateway console -&gt;
 Resources -&gt; Get method</p>

<p><img src="/images/lambda-integration-req1.png" alt="Screenshot" /></p>

<p>Test -&gt; Enter dev into <code class="language-plaintext highlighter-rouge">Stage</code> stage variable.</p>

<p><img src="/images/dev-test.png" alt="dev stage var" /></p>

<p>Test -&gt; Enter prod into <code class="language-plaintext highlighter-rouge">Stage</code> stage variable.</p>

<p><img src="/images/prod-test.png" alt="prod stage var" /></p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#aws,-ref">
					aws, <span>(6)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#lambda,-ref">
					lambda, <span>(2)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#serverless,cloudformation-ref">
					serverless,cloudformation <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Multi stage api gateway deployment with serverless framework.&via=shaytac"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="/assets/imgs/profileimg.jpg" class="img-rounded author-image" />
        <h4 class="section-title author-name">serkan haytac</h4>
        <p class="author-bio"><a href="https://www.certmetrics.com/amazon/public/badge.aspx?i=1&t=c&d=2016-07-01&ci=AWS00186868">AWS Certified Solutions Architect - Associate</a><br /><a href="https://www.certmetrics.com/amazon/public/badge.aspx?i=2&t=c&d=2016-07-23&ci=AWS00186868">AWS Certified Developer - Associate</a><br /><a href="https://www.certmetrics.com/amazon/public/badge.aspx?i=3&t=c&d=2018-01-12&ci=AWS00186868">AWS Certified SysOps Administrator - Associate</a><br /> <a href="https://gist.github.com/serkanh">Gists</><br /><a href="/resources">Resources</a><br /><a href="/one-liners">One liners</a><br/>
<br />
<a href="https://github.com/serkanh/react-cognito-starter">React/Serverless cognito starter</a><br/>
<a href="https://github.com/serkanh/github-explorer">React github explorer</a><br/>
<a href="https://github.com/serkanh/aws-eks">Terraform AWS EKS POC</a><br/>
<a href="https://github.com/serkanh/ecs-audit-js">JS/AWS ECS audit util</a><br/>
<a href="https://github.com/serkanh/django-multitenant-starter">Django multi-tenant starter</a><br/>
<a href="https://github.com/serkanh/nginx-docker">Dockerized nginx for config tests</a><br/>
<a href="https://github.com/serkanh/devops-panel">Serverless/React ui to manage ecs clusters</a><br/>
</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/aws,/rds,/cli/2018/07/11/aws-cli-rds-commands.html" title="Useful aws cli rds  commands i use often. ">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/aws,/ec2,/cli/2018/08/20/useful-aws-cli-ec2-commands.html" title="Useful EC2 cli commands. ">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2019 serkan haytac with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-900551-54"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-900551-54');
</script>


